services:
  web:
    image: node:22-slim
    working_dir: /app
    volumes:
      - ./web:/app
      - ./data/web_node_modules:/app/node_modules
      # Mount Firebase service account key
      - ./firebase-service-account.json:/app/secrets/firebase-service-account.json:ro
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://phonemcp:phonemcp@postgres:5432/phonemcp
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/firebase-service-account.json
      - WORKER_WS_URL=ws://worker:8080
      - WORKER_WS_EXTERNAL_URL=${WORKER_WS_EXTERNAL_URL:-ws://localhost:8080}
    command: sh -c "npm install && npm run dev -- --hostname 0.0.0.0"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    build: ./worker
    volumes:
      - ./worker:/app
    ports:
      - "8080:8080"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://phonemcp:phonemcp@postgres:5432/phonemcp
      - PORT=8080
      - RUST_LOG=info
      # Self-registration with API server
      - REGISTER_WITH_SERVER=${REGISTER_WITH_SERVER:-false}
      - API_URL=http://web:3000
      - WORKER_EXTERNAL_URL=${WORKER_EXTERNAL_URL:-ws://localhost:8080}
      - WORKER_REGION=${WORKER_REGION:-local}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: phonemcp
      POSTGRES_PASSWORD: phonemcp
      POSTGRES_DB: phonemcp
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U phonemcp"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
